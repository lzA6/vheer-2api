é¡¹ç›® 'vheer-2api' çš„ç»“æ„æ ‘:
ğŸ“‚ vheer-2api/
    ğŸ“„ .env
    ğŸ“„ .env.example
    ğŸ“„ Dockerfile
    ğŸ“„ docker-compose.yml
    ğŸ“„ main.py
    ğŸ“„ nginx.conf
    ğŸ“„ requirements.txt
    ğŸ“‚ app/
        ğŸ“‚ core/
            ğŸ“„ __init__.py
            ğŸ“„ config.py
        ğŸ“‚ providers/
            ğŸ“„ __init__.py
            ğŸ“„ base_provider.py
            ğŸ“„ vheer_provider.py
        ğŸ“‚ utils/
            ğŸ“„ sse_utils.py
    ğŸ“‚ static/
        ğŸ“„ index.html
        ğŸ“„ script.js
        ğŸ“„ style.css
================================================================================

--- æ–‡ä»¶è·¯å¾„: .env ---

# [è‡ªåŠ¨å¡«å……] vheer-2api ç”Ÿäº§ç¯å¢ƒé…ç½®
# è¯¥æ–‡ä»¶ç”± Genesis Protocol v8.0 è‡ªåŠ¨ç”Ÿæˆï¼Œå¯ç›´æ¥ç”¨äºä¸€é”®éƒ¨ç½²ã€‚

# --- æ ¸å¿ƒå®‰å…¨é…ç½® ---
# ç”¨äºä¿æŠ¤æ‚¨çš„ API æœåŠ¡çš„è®¿é—®å¯†é’¥ï¼Œè¯·æŒ‰éœ€ä¿®æ”¹ä¸ºæ‚¨è‡ªå·±çš„å¤æ‚å¯†é’¥ã€‚
API_MASTER_KEY=1

# --- éƒ¨ç½²é…ç½® ---
# Nginx å¯¹å¤–æš´éœ²çš„ç«¯å£
NGINX_PORT=8088

# --- Vheer.com å‡­è¯ (å·²ä»æ‚¨æä¾›çš„æŠ“åŒ…æ•°æ®ä¸­è‡ªåŠ¨æå–) ---
# å¦‚æœæœåŠ¡å¤±æ•ˆï¼Œè¯·ç™»å½• vheer.com åï¼ŒæŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œåœ¨ç½‘ç»œ(Network)é¢æ¿æ‰¾åˆ°ä»»æ„è¯·æ±‚ï¼Œ
# ä»å…¶è¯·æ±‚å¤´(Request Headers)ä¸­å¤åˆ¶å®Œæ•´çš„ "cookie" å­—ç¬¦ä¸²å¹¶æ›´æ–°æ­¤å€¼ã€‚
VHEER_COOKIE="gppChoices=DBABRg~BFoAABA; _gid=GA1.2.1285030137.1761025494; g_state={\"i_l\":0,\"i_ll\":1761025493758}; Authorization=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MTE3OTY5LCJ1c2VybmFtZSI6InExMzY0NTk0NzQwN0BnbWFpbC5jb20iLCJwYXNzd29yZCI6IjVBNEY0RUE2M0Q1OEE1RjcyRUI5MEMwNzk0QTZDMTc2IiwiaWF0IjoxNzYxMDI3NTM3fQ.wfrVcCFJtSdT-V-qRSMW-MAhrx1rLNUCRExF51AR4A0; _ga=GA1.2.1565573183.1760505910; _ga_CD46LH948W=GS2.1.s1761027536$o4$g1$t1761029666$j58$l0$h0"

--- æ–‡ä»¶è·¯å¾„: .env.example ---

# ====================================================================
# vheer-2api é…ç½®æ–‡ä»¶æ¨¡æ¿
# ====================================================================
#
# è¯·å°†æ­¤æ–‡ä»¶é‡å‘½åä¸º ".env" å¹¶å¡«å…¥æ‚¨çš„å‡­è¯ã€‚
#

# --- æ ¸å¿ƒå®‰å…¨é…ç½® (å¿…é¡»è®¾ç½®) ---
# ç”¨äºä¿æŠ¤æ‚¨ API æœåŠ¡çš„è®¿é—®å¯†é’¥ã€‚
API_MASTER_KEY=sk-vheer-2api-default-key-please-change-me

# --- éƒ¨ç½²é…ç½® (å¯é€‰) ---
# Nginx å¯¹å¤–æš´éœ²çš„ç«¯å£
NGINX_PORT=8088

# --- Vheer.com å‡­è¯ (å¿…é¡»è®¾ç½®) ---
# è¯·ç™»å½• vheer.comï¼Œç„¶åæŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œåœ¨ç½‘ç»œ(Network)é¢æ¿æ‰¾åˆ°ä»»æ„ä¸€ä¸ªå‘å¾€ vheer.com æˆ– access.vheer.com çš„è¯·æ±‚ï¼Œ
# ä»å…¶è¯·æ±‚å¤´(Request Headers)ä¸­å¤åˆ¶å®Œæ•´çš„ "cookie" å­—ç¬¦ä¸²å¹¶ç²˜è´´äºæ­¤ã€‚
# ç¤ºä¾‹: VHEER_COOKIE="gppChoices=...; _gid=...; Authorization=eyJhbGciOi...; ..."
VHEER_COOKIE=""

--- æ–‡ä»¶è·¯å¾„: Dockerfile ---

# ====================================================================
# Dockerfile for vheer-2api (v1.0 - Playwright Edition)
# ====================================================================

FROM mcr.microsoft.com/playwright/python:v1.55.0-jammy

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
WORKDIR /app

# å®‰è£… Python ä¾èµ–
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

# åˆ›å»ºå¹¶åˆ‡æ¢åˆ°é root ç”¨æˆ·
RUN useradd --create-home appuser && \
    chown -R appuser:appuser /app
USER appuser

# æš´éœ²ç«¯å£å¹¶å¯åŠ¨
EXPOSE 8000
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "1"]

--- æ–‡ä»¶è·¯å¾„: docker-compose.yml ---

services:
  nginx:
    image: nginx:latest
    container_name: vheer-2api-nginx
    restart: always
    ports:
      - "${NGINX_PORT:-8088}:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - app
    networks:
      - vheer-net

  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: vheer-2api-app
    restart: unless-stopped
    env_file:
      - .env
    # å¢åŠ å…±äº«å†…å­˜å¤§å°ï¼Œè¿™å¯¹äº Playwright/Chromium çš„ç¨³å®šè¿è¡Œè‡³å…³é‡è¦
    shm_size: '2gb'
    networks:
      - vheer-net

networks:
  vheer-net:
    driver: bridge

--- æ–‡ä»¶è·¯å¾„: main.py ---

import sys
import json
from contextlib import asynccontextmanager
from typing import Optional

from fastapi import FastAPI, Request, HTTPException, Depends, Header, File, UploadFile, Form
from fastapi.responses import JSONResponse, HTMLResponse
from fastapi.staticfiles import StaticFiles
from loguru import logger

from app.core.config import settings
from app.providers.vheer_provider import VheerProvider, BrowserManager

# --- æ—¥å¿—é…ç½® ---
logger.remove()
# --- FIX: å°†æ—¥å¿—çº§åˆ«è°ƒæ•´ä¸º TRACE ä»¥è¾“å‡ºæœ€è¯¦ç»†çš„æ­¥éª¤ä¿¡æ¯ ---
logger.add(
    sys.stdout,
    level="TRACE",
    format="<green>{time:YYYY-MM-DD HH:mm:ss.SSS}</green> | <level>{level: <8}</level> | <cyan>{name}</cyan>:<cyan>{function}</cyan>:<cyan>{line}</cyan> - <level>{message}</level>",
    colorize=True
)

# --- å…¨å±€å®ä¾‹ ---
browser_manager = BrowserManager()
provider = VheerProvider(browser_manager)

@asynccontextmanager
async def lifespan(app: FastAPI):
    logger.info(f"åº”ç”¨å¯åŠ¨ä¸­... {settings.APP_NAME} v{settings.APP_VERSION}")
    await browser_manager.start_browser()
    logger.info("æœåŠ¡å·²è¿›å…¥ 'Headless-Browser-Proxy-Execution' æ¨¡å¼ã€‚")
    logger.info(f"API æœåŠ¡å°†åœ¨ http://localhost:{settings.NGINX_PORT} ä¸Šå¯ç”¨")
    logger.info(f"Web UI æµ‹è¯•ç•Œé¢å·²å¯ç”¨ï¼Œè¯·è®¿é—® http://localhost:{settings.NGINX_PORT}/")
    yield
    await browser_manager.close_browser()
    logger.info("åº”ç”¨å…³é—­ã€‚")

app = FastAPI(
    title=settings.APP_NAME,
    version=settings.APP_VERSION,
    description=settings.DESCRIPTION,
    lifespan=lifespan
)

app.mount("/static", StaticFiles(directory="static"), name="static")

async def verify_api_key(authorization: Optional[str] = Header(None)):
    if settings.API_MASTER_KEY and settings.API_MASTER_KEY != "1":
        if not authorization or "bearer" not in authorization.lower():
            raise HTTPException(status_code=401, detail="éœ€è¦ Bearer Token è®¤è¯ã€‚")
        token = authorization.split(" ")[-1]
        if token != settings.API_MASTER_KEY:
            raise HTTPException(status_code=403, detail="æ— æ•ˆçš„ API Keyã€‚")

@app.post("/v1/images/generations", dependencies=[Depends(verify_api_key)])
async def text_to_image(request: Request):
    try:
        request_data = await request.json()
        # --- ADD: å¢åŠ è¯¦ç»†çš„è¯·æ±‚è½½è·æ—¥å¿— ---
        logger.debug(f"æ”¶åˆ° /v1/images/generations è¯·æ±‚ï¼Œè½½è·: \n{json.dumps(request_data, ensure_ascii=False, indent=2)}")
        response = await provider.generate_from_text(request_data)
        # --- ADD: å¢åŠ è¯¦ç»†çš„å“åº”æ—¥å¿— ---
        if isinstance(response, JSONResponse):
             logger.debug(f"å‡†å¤‡è¿”å›å“åº”ï¼Œå†…å®¹: \n{json.dumps(response.body.decode('utf-8'), ensure_ascii=False, indent=2)}")
        return response
    except Exception as e:
        logger.error(f"å¤„ç†æ–‡ç”Ÿå›¾è¯·æ±‚æ—¶å‡ºé”™: {e}", exc_info=True)
        if isinstance(e, HTTPException):
            raise e
        raise HTTPException(status_code=500, detail=f"å†…éƒ¨æœåŠ¡å™¨é”™è¯¯: {e}")

@app.post("/v1/images/edits", dependencies=[Depends(verify_api_key)])
async def image_to_image(
    image: UploadFile = File(...),
    prompt: str = Form(...),
    model: str = Form("vheer-image-to-image"),
    creative_strength: int = Form(10),
    control_strength: int = Form(2)
):
    try:
        # --- ADD: å¢åŠ è¯¦ç»†çš„è¯·æ±‚è½½è·æ—¥å¿— ---
        logger.debug(f"æ”¶åˆ° /v1/images/edits è¯·æ±‚: prompt='{prompt}', model='{model}', creative_strength={creative_strength}, control_strength={control_strength}, image='{image.filename}'")
        image_bytes = await image.read()
        response = await provider.generate_from_image(
            prompt=prompt,
            image_bytes=image_bytes,
            creative_strength=creative_strength,
            control_strength=control_strength
        )
        if isinstance(response, JSONResponse):
             logger.debug(f"å‡†å¤‡è¿”å›å“åº”ï¼Œå†…å®¹: \n{json.dumps(response.body.decode('utf-8'), ensure_ascii=False, indent=2)}")
        return response
    except Exception as e:
        logger.error(f"å¤„ç†å›¾ç”Ÿå›¾è¯·æ±‚æ—¶å‡ºé”™: {e}", exc_info=True)
        if isinstance(e, HTTPException):
            raise e
        raise HTTPException(status_code=500, detail=f"å†…éƒ¨æœåŠ¡å™¨é”™è¯¯: {e}")

@app.post("/v1/video/generations", dependencies=[Depends(verify_api_key)])
async def image_to_video(
    image: UploadFile = File(...)
):
    try:
        # --- ADD: å¢åŠ è¯¦ç»†çš„è¯·æ±‚è½½è·æ—¥å¿— ---
        logger.debug(f"æ”¶åˆ° /v1/video/generations è¯·æ±‚: image='{image.filename}'")
        image_bytes = await image.read()
        response = await provider.generate_video_from_image(image_bytes=image_bytes)
        if isinstance(response, JSONResponse):
             logger.debug(f"å‡†å¤‡è¿”å›å“åº”ï¼Œå†…å®¹: \n{json.dumps(response.body.decode('utf-8'), ensure_ascii=False, indent=2)}")
        return response
    except Exception as e:
        logger.error(f"å¤„ç†å›¾ç”Ÿè§†é¢‘è¯·æ±‚æ—¶å‡ºé”™: {e}", exc_info=True)
        if isinstance(e, HTTPException):
            raise e
        raise HTTPException(status_code=500, detail=f"å†…éƒ¨æœåŠ¡å™¨é”™è¯¯: {e}")

@app.get("/v1/models", dependencies=[Depends(verify_api_key)])
async def list_models():
    return await provider.get_models()

@app.get("/", response_class=HTMLResponse, include_in_schema=False)
async def serve_ui():
    try:
        with open("static/index.html", "r", encoding="utf-8") as f:
            return HTMLResponse(content=f.read())
    except FileNotFoundError:
        raise HTTPException(status_code=404, detail="UI æ–‡ä»¶ (static/index.html) æœªæ‰¾åˆ°ã€‚")


--- æ–‡ä»¶è·¯å¾„: nginx.conf ---

worker_processes auto;

events {
    worker_connections 1024;
}

http {
    # å¢åŠ  proxy è¶…æ—¶æ—¶é—´ï¼Œä»¥åº”å¯¹å¯èƒ½è¾ƒé•¿çš„å›¾åƒ/è§†é¢‘ç”Ÿæˆæ—¶é—´
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;
    send_timeout 300s;

    upstream vheer_backend {
        # ip_hash ç¡®ä¿æ¥è‡ªåŒä¸€å®¢æˆ·ç«¯çš„è¯·æ±‚è¢«è½¬å‘åˆ°åŒä¸€ä¸ª worker
        # è¿™å¯¹äºä¿æŒä¼šè¯ä¸Šä¸‹æ–‡çš„è¿ç»­æ€§è‡³å…³é‡è¦
        ip_hash;
        server app:8000;
    }

    server {
        listen 80;
        server_name localhost;

        # å…è®¸ä¸Šä¼ æ›´å¤§çš„æ–‡ä»¶
        client_max_body_size 100M;

        location / {
            proxy_pass http://vheer_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}

--- æ–‡ä»¶è·¯å¾„: requirements.txt ---

fastapi
uvicorn[standard]
pydantic-settings
python-dotenv
loguru
playwright
python-multipart
aiofiles

--- æ–‡ä»¶è·¯å¾„: app\core\__init__.py ---



--- æ–‡ä»¶è·¯å¾„: app\core\config.py ---

import uuid
from pydantic_settings import BaseSettings, SettingsConfigDict
from pydantic import model_validator
from typing import Optional, List, Dict

class Settings(BaseSettings):
    model_config = SettingsConfigDict(
        env_file=".env",
        env_file_encoding='utf-8',
        extra="ignore"
    )

    APP_NAME: str = "vheer-2api"
    APP_VERSION: str = "1.0.0"
    DESCRIPTION: str = "ä¸€ä¸ªå°† vheer.com çš„æ–‡ç”Ÿå›¾ã€å›¾ç”Ÿå›¾ã€å›¾ç”Ÿè§†é¢‘åŠŸèƒ½è½¬æ¢ä¸ºå…¼å®¹ OpenAI æ ¼å¼ API çš„é«˜æ€§èƒ½ä»£ç†ã€‚"

    API_MASTER_KEY: Optional[str] = "1"
    NGINX_PORT: int = 8088
    VHEER_COOKIE: Optional[str] = None

    API_REQUEST_TIMEOUT: int = 300 # ç§’

    MODEL_MAPPING: Dict[str, str] = {
        "vheer-text-to-image-pro": "Pro Model",
        "vheer-text-to-image-max": "Max Model",
        "vheer-image-to-image": "Image-to-Image",
        "vheer-image-to-video": "Image-to-Video"
    }

    @model_validator(mode='after')
    def validate_settings(self) -> 'Settings':
        if not self.VHEER_COOKIE:
            raise ValueError("VHEER_COOKIE å¿…é¡»åœ¨ .env æ–‡ä»¶ä¸­è®¾ç½®ã€‚")
        return self

settings = Settings()

--- æ–‡ä»¶è·¯å¾„: app\providers\__init__.py ---



--- æ–‡ä»¶è·¯å¾„: app\providers\base_provider.py ---

from abc import ABC, abstractmethod
from typing import Dict, Any
from fastapi.responses import StreamingResponse, JSONResponse

class BaseProvider(ABC):
    @abstractmethod
    async def chat_completion(
        self,
        request_data: Dict[str, Any]
    ) -> StreamingResponse:
        pass

    @abstractmethod
    async def get_models(self) -> JSONResponse:
        pass


--- æ–‡ä»¶è·¯å¾„: app\providers\vheer_provider.py ---

import asyncio
import time
import json
from typing import Dict, Any, Optional
from pathlib import Path
import tempfile

from loguru import logger
from fastapi import HTTPException
from fastapi.responses import JSONResponse
from playwright.async_api import async_playwright, Browser, Page, BrowserContext, TimeoutError as PlaywrightTimeoutError

from app.core.config import settings

class BrowserManager:
    """ç®¡ç† Playwright æµè§ˆå™¨å®ä¾‹å’Œå¹¶å‘é”ã€‚"""
    def __init__(self):
        self.playwright = None
        self.browser: Optional[Browser] = None
        self.context: Optional[BrowserContext] = None
        self.lock = asyncio.Lock()

    async def start_browser(self):
        logger.info("æ­£åœ¨å¯åŠ¨ Playwright æµè§ˆå™¨...")
        self.playwright = await async_playwright().start()
        self.browser = await self.playwright.chromium.launch(headless=True)
        
        cookies = []
        if settings.VHEER_COOKIE:
            cookie_parts = settings.VHEER_COOKIE.split(';')
            for part in cookie_parts:
                if '=' in part:
                    name, value = part.strip().split('=', 1)
                    cookies.append({"name": name, "value": value, "domain": ".vheer.com", "path": "/"})
        
        self.context = await self.browser.new_context()
        if cookies:
            await self.context.add_cookies(cookies)
            logger.success("æµè§ˆå™¨å¯åŠ¨å¹¶å·²è®¾ç½® Cookieã€‚")
        else:
            logger.warning("VHEER_COOKIE æœªè®¾ç½®ï¼Œæµè§ˆå™¨æœªåŠ è½½ä»»ä½• Cookieã€‚")

    async def new_page(self) -> Page:
        if not self.context:
            raise RuntimeError("æµè§ˆå™¨ä¸Šä¸‹æ–‡æœªåˆå§‹åŒ–ã€‚")
        return await self.context.new_page()

    async def close_browser(self):
        if self.context:
            await self.context.close()
        if self.browser:
            await self.browser.close()
        if self.playwright:
            await self.playwright.stop()
        logger.info("æµè§ˆå™¨å·²å…³é—­ã€‚")


class VheerProvider:
    def __init__(self, browser_manager: BrowserManager):
        self.browser_manager = browser_manager

    async def _execute_in_browser(self, task_coro):
        """å¸¦é”æ‰§è¡Œæµè§ˆå™¨ä»»åŠ¡çš„é€šç”¨åŒ…è£…å™¨ã€‚"""
        async with self.browser_manager.lock:
            page = None
            try:
                result = await asyncio.wait_for(task_coro(), timeout=settings.API_REQUEST_TIMEOUT + 120)
                return result
            except asyncio.TimeoutError:
                logger.error(f"æµè§ˆå™¨ä»»åŠ¡å› æ€»è¶…æ—¶è€Œå¤±è´¥ï¼ˆè¶…è¿‡ {settings.API_REQUEST_TIMEOUT + 120} ç§’ï¼‰ã€‚")
                raise HTTPException(status_code=504, detail="ä¸Šæ¸¸æœåŠ¡å“åº”è¶…æ—¶ã€‚")
            except PlaywrightTimeoutError as e:
                logger.error(f"Playwright æ“ä½œè¶…æ—¶: {e}", exc_info=True)
                raise HTTPException(status_code=502, detail=f"ä¸ä¸Šæ¸¸æœåŠ¡äº¤äº’è¶…æ—¶: {e}")
            except Exception as e:
                logger.error(f"æµè§ˆå™¨ä»»åŠ¡æ‰§è¡Œæ—¶å‘ç”ŸæœªçŸ¥é”™è¯¯: {e}", exc_info=True)
                raise HTTPException(status_code=502, detail=f"ä¸ä¸Šæ¸¸æœåŠ¡äº¤äº’æ—¶å‡ºé”™: {e}")

    async def _create_page_with_logging(self) -> Page:
        """åˆ›å»ºä¸€ä¸ªæ–°é¡µé¢å¹¶é™„åŠ è¯¦ç»†çš„ç½‘ç»œæ—¥å¿—è®°å½•å™¨ã€‚"""
        page = await self.browser_manager.new_page()
        logger.debug("--- [ç½‘ç»œæ—¥å¿—è®°å½•å™¨å·²æ¿€æ´»] ---")
        
        async def log_request(request):
            if "data:image" not in request.url and "google" not in request.url and "ezoic" not in request.url and "quantserve" not in request.url:
                post_data = request.post_data or "N/A"
                logger.trace(f"==> [è¯·æ±‚] {request.method} {request.url} | è½½è·: {post_data[:300]}")

        async def log_response(response):
            if "data:image" not in response.url and "google" not in response.url and "ezoic" not in response.url and "quantserve" not in response.url:
                status = response.status
                try:
                    body = await response.text()
                    log_body = body[:500].strip() + "..." if len(body) > 500 else body.strip()
                except Exception:
                    log_body = "[äºŒè¿›åˆ¶æˆ–æ— æ³•è§£æçš„å“åº”ä½“]"
                logger.trace(f"<== [å“åº”] {status} {response.url} | å“åº”ä½“: {log_body}")

        page.on("request", lambda req: asyncio.create_task(log_request(req)))
        page.on("response", lambda res: asyncio.create_task(log_response(res)))
        return page

    async def _wait_for_result_url(self, page: Page, target_url_prefix: str, media_suffix: tuple) -> str:
        """
        æœ€ç»ˆå†³æˆ˜æ–¹æ¡ˆï¼šé€šè¿‡ç›‘å¬ç½‘ç»œå“åº”æ¥è·å–ç»“æœURLã€‚
        è¿™ä¸ªæ–¹æ³•ç»“åˆäº†ä¸¤ç§ç­–ç•¥ï¼š
        1. ä¸»è¦ç­–ç•¥ï¼šç›‘å¬å‘å¾€ vheer.com/app/... çš„ POST è¯·æ±‚å“åº”ï¼Œè§£æå…¶ä¸­çš„ JSON æ•°æ®ï¼Œå¯»æ‰¾æˆåŠŸçŠ¶æ€å’Œä¸‹è½½é“¾æ¥ã€‚
        2. åå¤‡ç­–ç•¥ï¼šç›‘å¬å¯¹æœ€ç»ˆåª’ä½“æ–‡ä»¶ï¼ˆ.jpg, .mp4ï¼‰çš„ç›´æ¥è¯·æ±‚ã€‚
        """
        result_future = asyncio.Future()
        
        async def handle_response(response):
            # ä¸»è¦ç­–ç•¥ï¼šæ•è·åŒ…å«æˆåŠŸçŠ¶æ€çš„JSONå“åº”
            if response.url.startswith(target_url_prefix) and response.request.method == "POST":
                try:
                    text = await response.text()
                    # å“åº”å¯èƒ½æ˜¯å¤šè¡Œï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°åŒ…å«JSONçš„éƒ¨åˆ†
                    for line in text.splitlines():
                        if '"message":"Success"' in line and '"status":"success"' in line:
                            json_start = line.find('{')
                            if json_start != -1:
                                json_text = line[json_start:]
                                data = json.loads(json_text)
                                download_urls = data.get("data", {}).get("downloadUrls")
                                if download_urls and not result_future.done():
                                    logger.success(f"ã€ä¸»è¦æ–¹æ¡ˆã€‘æ‹¦æˆªæˆåŠŸ! ä»JSONå¿ƒè·³åŒ…ä¸­æå–åˆ°URL: {download_urls[0]}")
                                    result_future.set_result(download_urls[0])
                                    return
                except (json.JSONDecodeError, KeyError, IndexError):
                    pass  # å¿½ç•¥è§£æå¤±è´¥æˆ–ç»“æ„ä¸ç¬¦çš„å“åº”

            # åå¤‡ç­–ç•¥ï¼šæ•è·å¯¹åª’ä½“æ–‡ä»¶çš„ç›´æ¥è¯·æ±‚
            if "access.vheer.com/results/" in response.url and response.url.endswith(media_suffix) and not result_future.done():
                logger.success(f"ã€åå¤‡æ–¹æ¡ˆã€‘æ‹¦æˆªæˆåŠŸ! ç›‘å¬åˆ°æœ€ç»ˆåª’ä½“æ–‡ä»¶URL: {response.url}")
                result_future.set_result(response.url)

        page.on("response", lambda res: asyncio.create_task(handle_response(res)))
        
        logger.info("æ­£åœ¨ç­‰å¾…ç»“æœURL... (å°†æŒç»­æ£€æŸ¥ï¼Œæœ€é•¿5åˆ†é’Ÿ)")
        try:
            # æˆ‘ä»¬åœ¨è¿™é‡Œç­‰å¾…ï¼Œè€Œä¸æ˜¯åœ¨é¡µé¢ä¸Šå¯»æ‰¾å…ƒç´ 
            result_url = await asyncio.wait_for(result_future, timeout=settings.API_REQUEST_TIMEOUT)
            return result_url
        except asyncio.TimeoutError:
            logger.error("åœ¨æŒ‡å®šæ—¶é—´å†…æœªèƒ½é€šè¿‡ç½‘ç»œç›‘å¬æ•è·åˆ°ä»»ä½•æœ‰æ•ˆçš„ç»“æœURLã€‚")
            raise

    async def generate_from_text(self, request_data: Dict[str, Any]) -> JSONResponse:
        async def task():
            page = await self._create_page_with_logging()
            try:
                prompt = request_data.get("prompt")
                size = request_data.get("size", "1:1")
                
                logger.debug(">>> [START] æµè§ˆå™¨ä»»åŠ¡: æ–‡ç”Ÿå›¾")
                await page.goto("https://vheer.com/app/text-to-image", wait_until="networkidle")
                logger.debug("æ­¥éª¤ 1/4: é¡µé¢å¯¼èˆªå®Œæˆã€‚")

                prompt_selector = 'textarea[placeholder*="Steampunk flying bicycle"]'
                await page.wait_for_selector(prompt_selector, timeout=30000)
                await page.fill(prompt_selector, prompt)
                logger.debug("æ­¥éª¤ 2/4: æç¤ºè¯å·²å¡«å…¥ã€‚")

                aspect_ratio_dropdown_selector = 'button#hs-dropdown-hover-event'
                aspect_ratio_option_selector = f'div.hs-dropdown-menu div.p-1 div:has-text("{size}")'
                await page.click(aspect_ratio_dropdown_selector)
                await page.click(aspect_ratio_option_selector)
                logger.debug(f"æ­¥éª¤ 3/4: å›¾ç‰‡æ¯”ä¾‹ '{size}' å·²é€‰æ‹©ã€‚")

                await page.click('button:has-text("Generate")')
                logger.debug("æ­¥éª¤ 4/4: 'Generate' æŒ‰é’®å·²ç‚¹å‡»ï¼Œå¼€å§‹ç›‘å¬ç½‘ç»œä»¥æ•è·ç»“æœ...")

                result_url = await self._wait_for_result_url(page, "https://vheer.com/app/text-to-image", (".jpg", ".png", ".webp"))
                
                response_data = {"created": int(time.time()), "data": [{"url": result_url}]}
                logger.success("<<< [SUCCESS] æµè§ˆå™¨ä»»åŠ¡: æ–‡ç”Ÿå›¾å·²å®Œæˆã€‚")
                return JSONResponse(content=response_data)
            finally:
                if page and not page.is_closed(): await page.close()
        return await self._execute_in_browser(task)

    async def generate_from_image(self, prompt: str, image_bytes: bytes, creative_strength: int, control_strength: int) -> JSONResponse:
        async def task():
            page = await self._create_page_with_logging()
            try:
                logger.debug(">>> [START] æµè§ˆå™¨ä»»åŠ¡: å›¾ç”Ÿå›¾")
                await page.goto("https://vheer.com/app/image-to-image", wait_until="networkidle")
                logger.debug("æ­¥éª¤ 1/6: é¡µé¢å¯¼èˆªå®Œæˆã€‚")

                with tempfile.NamedTemporaryFile(delete=False, suffix=".png") as tmp_file:
                    tmp_file.write(image_bytes)
                    tmp_file_path = tmp_file.name
                
                await page.set_input_files('input[type="file"]', tmp_file_path)
                logger.debug("æ­¥éª¤ 2/6: å›¾ç‰‡å·²æäº¤ä¸Šä¼ ã€‚")
                
                processing_overlay_selector = 'div:has-text("Processing...")'
                await page.wait_for_selector(processing_overlay_selector, state='hidden', timeout=60000)
                logger.debug("æ­¥éª¤ 3/6: å›¾ç‰‡å¤„ç†å®Œæˆã€‚")

                prompt_selector = 'div:has-text("Positive prompts") >> textarea'
                await page.wait_for_selector(prompt_selector, timeout=30000)
                await page.fill(prompt_selector, prompt)
                logger.debug("æ­¥éª¤ 4/6: æç¤ºè¯å·²å¡«å…¥ã€‚")

                await page.evaluate(f"document.getElementById('creative-strength').value = {creative_strength}; document.getElementById('creative-strength').dispatchEvent(new Event('input', {{ 'bubbles': true }}));")
                await page.evaluate(f"document.getElementById('control-strength').value = {control_strength}; document.getElementById('control-strength').dispatchEvent(new Event('input', {{ 'bubbles': true }}));")
                logger.debug("æ­¥éª¤ 5/6: æ»‘å—å€¼è®¾ç½®å®Œæˆã€‚")
                
                await page.click('button:has-text("Generate")')
                logger.debug("æ­¥éª¤ 6/6: 'Generate' æŒ‰é’®å·²ç‚¹å‡»ï¼Œå¼€å§‹ç›‘å¬ç½‘ç»œä»¥æ•è·ç»“æœ...")

                result_url = await self._wait_for_result_url(page, "https://vheer.com/app/image-to-image", (".jpg", ".png", ".webp"))

                Path(tmp_file_path).unlink()
                response_data = {"created": int(time.time()), "data": [{"url": result_url}]}
                logger.success("<<< [SUCCESS] æµè§ˆå™¨ä»»åŠ¡: å›¾ç”Ÿå›¾å·²å®Œæˆã€‚")
                return JSONResponse(content=response_data)
            finally:
                if page and not page.is_closed(): await page.close()
        return await self._execute_in_browser(task)

    async def generate_video_from_image(self, image_bytes: bytes) -> JSONResponse:
        async def task():
            page = await self._create_page_with_logging()
            try:
                logger.debug(">>> [START] æµè§ˆå™¨ä»»åŠ¡: å›¾ç”Ÿè§†é¢‘")
                await page.goto("https://vheer.com/app/image-to-video", wait_until="networkidle")
                logger.debug("æ­¥éª¤ 1/3: é¡µé¢å¯¼èˆªå®Œæˆã€‚")

                with tempfile.NamedTemporaryFile(delete=False, suffix=".png") as tmp_file:
                    tmp_file.write(image_bytes)
                    tmp_file_path = tmp_file.name

                await page.set_input_files('input[type="file"]', tmp_file_path)
                logger.debug("æ­¥éª¤ 2/3: å›¾ç‰‡ä¸Šä¼ å®Œæˆã€‚")

                await page.click('button:has-text("Generate")')
                logger.debug("æ­¥éª¤ 3/3: 'Generate' æŒ‰é’®å·²ç‚¹å‡»ï¼Œå¼€å§‹ç›‘å¬ç½‘ç»œä»¥æ•è·ç»“æœ...")

                result_url = await self._wait_for_result_url(page, "https://vheer.com/app/image-to-video", (".mp4",))

                Path(tmp_file_path).unlink()
                response_data = {"created": int(time.time()), "data": [{"url": result_url}]}
                logger.success("<<< [SUCCESS] æµè§ˆå™¨ä»»åŠ¡: å›¾ç”Ÿè§†é¢‘å·²å®Œæˆã€‚")
                return JSONResponse(content=response_data)
            finally:
                if page and not page.is_closed(): await page.close()
        return await self._execute_in_browser(task)

    async def get_models(self) -> JSONResponse:
        model_list = {
            "object": "list",
            "data": [{"id": name, "object": "model", "created": int(time.time()), "owned_by": "vheer-2api"} for name in settings.MODEL_MAPPING.keys()]
        }
        return JSONResponse(content=model_list)


--- æ–‡ä»¶è·¯å¾„: app\utils\sse_utils.py ---

import json
import time
from typing import Dict, Any, Optional

DONE_CHUNK = b"data: [DONE]\n\n"

def create_sse_data(data: Dict[str, Any]) -> bytes:
    """å°†å­—å…¸æ•°æ®æ ¼å¼åŒ–ä¸º SSE äº‹ä»¶å­—ç¬¦ä¸²ã€‚"""
    return f"data: {json.dumps(data, ensure_ascii=False)}\n\n".encode('utf-8')

def create_chat_completion_chunk(
    request_id: str,
    model: str,
    content: str,
    finish_reason: Optional[str] = None
) -> Dict[str, Any]:
    """åˆ›å»ºä¸€ä¸ªä¸ OpenAI å…¼å®¹çš„èŠå¤©è¡¥å…¨æµå¼å—ã€‚"""
    return {
        "id": request_id,
        "object": "chat.completion.chunk",
        "created": int(time.time()),
        "model": model,
        "choices": [
            {
                "index": 0,
                "delta": {"content": content},
                "finish_reason": finish_reason
            }
        ]
    }


--- æ–‡ä»¶è·¯å¾„: static\index.html ---

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vheer-2API æµ‹è¯•é¢æ¿</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>Vheer-2API æµ‹è¯•é¢æ¿</h1>
        <div class="api-key-container">
            <label for="api-key">API Key:</label>
            <input type="password" id="api-key" value="1">
        </div>

        <div class="tabs">
            <button class="tab-link active" onclick="openTab(event, 't2i')">æ–‡ç”Ÿå›¾</button>
            <button class="tab-link" onclick="openTab(event, 'i2i')">å›¾ç”Ÿå›¾</button>
            <button class="tab-link" onclick="openTab(event, 'i2v')">å›¾ç”Ÿè§†é¢‘</button>
        </div>

        <!-- æ–‡ç”Ÿå›¾ Tab -->
        <div id="t2i" class="tab-content active">
            <h2>æ–‡ç”Ÿå›¾ (Text-to-Image)</h2>
            <form id="t2i-form">
                <div class="form-group">
                    <label for="t2i-prompt">æç¤ºè¯ (Prompt)</label>
                    <textarea id="t2i-prompt" required placeholder="ä¾‹å¦‚ï¼šä¸€åªç©¿ç€å®‡èˆªæœçš„çŒ«åœ¨æœˆçƒä¸Š"></textarea>
                </div>
                <div class="form-group">
                    <label for="t2i-model">æ¨¡å‹ (Model)</label>
                    <select id="t2i-model">
                        <option value="vheer-text-to-image-pro" selected>Pro Model</option>
                        <option value="vheer-text-to-image-max">Max Model</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="t2i-size">æ¯”ä¾‹ (Aspect Ratio)</label>
                    <select id="t2i-size">
                        <option value="1:1" selected>1:1 (æ–¹å½¢)</option>
                        <option value="1:2">1:2</option>
                        <option value="2:1">2:1</option>
                        <option value="2:3">2:3</option>
                        <option value="3:2">3:2</option>
                        <option value="3:4">3:4</option>
                        <option value="4:3">4:3</option>
                        <option value="4:5">4:5</option>
                        <option value="5:4">5:4</option>
                        <option value="9:16">9:16 (ç«–å±)</option>
                        <option value="16:9">16:9 (æ¨ªå±)</option>
                    </select>
                </div>
                <button type="submit">ç”Ÿæˆå›¾åƒ</button>
            </form>
        </div>

        <!-- å›¾ç”Ÿå›¾ Tab -->
        <div id="i2i" class="tab-content">
            <h2>å›¾ç”Ÿå›¾ (Image-to-Image)</h2>
            <form id="i2i-form">
                <div class="form-group">
                    <label for="i2i-image">ä¸Šä¼ å›¾ç‰‡</label>
                    <input type="file" id="i2i-image" accept="image/*" required>
                </div>
                <div class="form-group">
                    <label for="i2i-prompt">æç¤ºè¯ (Prompt)</label>
                    <textarea id="i2i-prompt" required placeholder="æè¿°ä½ å¸Œæœ›å¦‚ä½•ä¿®æ”¹å›¾ç‰‡"></textarea>
                </div>
                <div class="form-group slider-group">
                    <label for="creative-strength">åˆ›æ„å®åŠ› (Creative Strength): <span id="creative-value">10</span></label>
                    <input type="range" id="creative-strength" min="1" max="10" value="10">
                </div>
                <div class="form-group slider-group">
                    <label for="control-strength">æ§åˆ¶å¼ºåº¦ (Control Strength): <span id="control-value">2</span></label>
                    <input type="range" id="control-strength" min="1" max="10" value="2">
                </div>
                <button type="submit">ç”Ÿæˆå›¾åƒ</button>
            </form>
        </div>

        <!-- å›¾ç”Ÿè§†é¢‘ Tab -->
        <div id="i2v" class="tab-content">
            <h2>å›¾ç”Ÿè§†é¢‘ (Image-to-Video)</h2>
            <form id="i2v-form">
                <div class="form-group">
                    <label for="i2v-image">ä¸Šä¼ å›¾ç‰‡</label>
                    <input type="file" id="i2v-image" accept="image/*" required>
                </div>
                <button type="submit">ç”Ÿæˆè§†é¢‘</button>
            </form>
        </div>

        <div id="result-container" class="hidden">
            <h3>ç”Ÿæˆç»“æœ</h3>
            <div id="spinner" class="spinner hidden"></div>
            <div id="result-output"></div>
        </div>
    </div>
    <script src="/static/script.js"></script>
</body>
</html>

--- æ–‡ä»¶è·¯å¾„: static\script.js ---

function openTab(evt, tabName) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    tablinks = document.getElementsByClassName("tab-link");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.className += " active";
}

document.addEventListener('DOMContentLoaded', () => {
    const apiKeyInput = document.getElementById('api-key');
    const resultContainer = document.getElementById('result-container');
    const resultOutput = document.getElementById('result-output');
    const spinner = document.getElementById('spinner');

    // --- Sliders ---
    const creativeSlider = document.getElementById('creative-strength');
    const creativeValue = document.getElementById('creative-value');
    const controlSlider = document.getElementById('control-strength');
    const controlValue = document.getElementById('control-value');

    creativeSlider.oninput = () => creativeValue.textContent = creativeSlider.value;
    controlSlider.oninput = () => controlValue.textContent = controlSlider.value;

    // --- Form Handlers ---
    document.getElementById('t2i-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        setLoading(true);
        const payload = {
            prompt: document.getElementById('t2i-prompt').value,
            model: document.getElementById('t2i-model').value,
            size: document.getElementById('t2i-size').value,
            n: 1,
            response_format: "url"
        };
        try {
            const response = await fetch('/v1/images/generations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKeyInput.value}`
                },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            handleResult(result, 'image');
        } catch (error) {
            handleError(error);
        } finally {
            setLoading(false);
        }
    });

    document.getElementById('i2i-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        setLoading(true);
        const formData = new FormData();
        formData.append('image', document.getElementById('i2i-image').files[0]);
        formData.append('prompt', document.getElementById('i2i-prompt').value);
        formData.append('creative_strength', creativeSlider.value);
        formData.append('control_strength', controlSlider.value);

        try {
            const response = await fetch('/v1/images/edits', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${apiKeyInput.value}` },
                body: formData
            });
            const result = await response.json();
            handleResult(result, 'image');
        } catch (error) {
            handleError(error);
        } finally {
            setLoading(false);
        }
    });

    document.getElementById('i2v-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        setLoading(true);
        const formData = new FormData();
        formData.append('image', document.getElementById('i2v-image').files[0]);

        try {
            const response = await fetch('/v1/video/generations', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${apiKeyInput.value}` },
                body: formData
            });
            const result = await response.json();
            handleResult(result, 'video');
        } catch (error) {
            handleError(error);
        } finally {
            setLoading(false);
        }
    });

    // --- Helper Functions ---
    function setLoading(isLoading) {
        spinner.classList.toggle('hidden', !isLoading);
        resultContainer.classList.remove('hidden');
        if (isLoading) {
            resultOutput.innerHTML = '';
        }
    }

    function handleResult(result, type) {
        if (result.detail) {
            handleError(new Error(result.detail));
            return;
        }
        const url = result.data[0].url;
        if (type === 'image') {
            resultOutput.innerHTML = `<img src="${url}" alt="Generated Image"><p><a href="${url}" target="_blank">${url}</a></p>`;
        } else if (type === 'video') {
            resultOutput.innerHTML = `<video controls src="${url}"></video><p><a href="${url}" target="_blank">${url}</a></p>`;
        }
    }

    function handleError(error) {
        resultOutput.innerHTML = `<div class="error">é”™è¯¯: ${error.message}</div>`;
    }
});

--- æ–‡ä»¶è·¯å¾„: static\style.css ---

body {
    font-family: sans-serif;
    background-color: #f0f2f5;
    color: #333;
    margin: 0;
    padding: 20px;
    display: flex;
    justify-content: center;
}
.container {
    width: 100%;
    max-width: 800px;
    background-color: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
h1, h2 { text-align: center; }
.api-key-container { margin-bottom: 20px; text-align: center; }
.tabs { overflow: hidden; border-bottom: 1px solid #ccc; margin-bottom: 20px; }
.tab-link {
    background-color: #f1f1f1;
    float: left;
    border: none;
    outline: none;
    cursor: pointer;
    padding: 14px 16px;
    transition: background-color 0.3s;
    font-size: 17px;
}
.tab-link:hover { background-color: #ddd; }
.tab-link.active { background-color: #ccc; }
.tab-content { display: none; padding: 6px 12px; border-top: none; }
.tab-content.active { display: block; }
.form-group { margin-bottom: 15px; }
label { display: block; margin-bottom: 5px; font-weight: bold; }
input[type="text"], input[type="password"], textarea, select, input[type="file"] {
    width: 100%;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
}
textarea { resize: vertical; min-height: 80px; }
button {
    background-color: #4CAF50;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    width: 100%;
}
button:hover { background-color: #45a049; }
#result-container { margin-top: 20px; text-align: center; }
#result-output img, #result-output video { max-width: 100%; border-radius: 4px; margin-top: 10px; }
.error { color: red; font-weight: bold; }
.hidden { display: none; }
.spinner {
    border: 4px solid rgba(0,0,0,0.1);
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border-left-color: #09f;
    animation: spin 1s ease infinite;
    margin: 20px auto;
}
.slider-group { display: flex; flex-direction: column; }
.slider-group label { display: flex; justify-content: space-between; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }


